#
# Test of the scripting interface
#
DIAGRAM = "app75/family75/routing"
DATAPUMP="DATAPUMP-3"
QUALVALUE="QUALVALUE-805"
Show: diagram $DIAGRAM
resetDiagram ($DIAGRAM)

# Script aliases used for this test
script: getDiagramNameForBlock blockProxy.getDiagramForBlock(dpath,name)
script: blocksDownstream interfaces.listBlocksDownstreamOf(dpath,bname)
script: blocksGloballyDownstream interfaces.listBlocksGloballyDownstreamOf(dpath,bname)
script: blocksForTag interfaces.listBlocksForTag(tagpath)
script: blocksInDiagram interfaces.listBlocksInDiagram(dpath)
script: blocksOfClass interfaces.listBlocksOfClass(dpath,clss)
script: blocksOfClassDownstream interfaces.listBlocksOfClassDownstream(dpath,name,clss)
script: blocksOfClassUpstream interfaces.listBlocksOfClassUpstream(dpath,name,clss)
script: blocksUpstream interfaces.listBlocksUpstreamOf(dpath,bname)
script: blocksGloballyUpstream interfaces.listBlocksGloballyUpstreamOf(dpath,bname)
script: getBlockProperty blockProxy.getBlockProperty(dpath,block,property)
script: pathForBlock   interfaces.pathForBlock(dpath,bname)
script: setBlockProperty blockProxy.setBlockProperty(dpath,block,property,value)
script: sinksForSource interfaces.listSinksForSource(dpath,bname)
script: sourcesForSink interfaces.listSourcesForSink(dpath,bname)

Test: Scripting Interface on Routing Diagram
Step: Block Properties
setBlockProperty($DIAGRAM,$DATAPUMP,"LiveOnStart","TRUE")
assert: getBlockProperty($DIAGRAM,$DATAPUMP,"LiveOnStart") = True "Get LiveOnStart in DATAPUMP-3"
setBlockProperty($DIAGRAM,$DATAPUMP,"LiveOnStart","FALSE")

Step: Diagram Name from Block
assert: getDiagramNameForBlock($DIAGRAM,$DATAPUMP) = "routing" "Obtain diagram name from blockId"

Step: Blocks in Diagram
assert: blocksInDiagram($DIAGRAM) contains "INHIBITOR-551" "Inhibitor-551 is in diagram"
assert: blocksInDiagram($DIAGRAM) contains "RoutingParameter" "RountingParameter is in diagram"
assert: count of blocksInDiagram($DIAGRAM) = 22 "22 blocks in diagram"

Step: Blocks of Class
assert: blocksOfClass($DIAGRAM,"com.ils.block.Inhibitor") contains "INHIBITOR-551" "Inhibitor-551 is an Inhibitor"
assert: blocksOfClass($DIAGRAM,"com.ils.block.Parameter") contains "RoutingParameter" "RountingParameter is a Parameter"
assert: ! blocksOfClass($DIAGRAM,"com.ils.block.Input") contains "INHIBITOR-551" "Inhibitor-551 is not an Input"
assert: count of blocksOfClass($DIAGRAM,"com.ils.block.DataPump") = 6 "6 data pumps"
assert: blocksOfClassDownstream($DIAGRAM,"DATAPUMP-4","com.ils.block.QualValue") contains $QUALVALUE "QualValue-805 is downstream of DataPump-4"
assert: blocksOfClassUpstream($DIAGRAM,$QUALVALUE,"com.ils.block.DataPump") contains "DATAPUMP-4" "DataPump-4 is upstream of QualValue-805"

Step: Downstream of Block
assert: blocksDownstream($DIAGRAM,"DATAPUMP-4") contains "QUALVALUE-805" "QualValue 805 is downstream of datapump 4"
assert: blocksDownstream($DIAGRAM,"DATAPUMP-4") contains "RoutingParameter" "RoutingParameter is downstream of datapump 4"
assert: count of blocksDownstream($DIAGRAM,"DATAPUMP-4") = 4  "4 blocks downstream of datapump 4"
assert: blocksDownstream($DIAGRAM,"COMMAND-225") contains "INHIBITOR-380" "Inhibitor 380 is downstream of command 225"
assert: ! blocksDownstream($DIAGRAM,"COMMAND-225") contains "RoutingParameter" "RoutingParameter is not downstream of command 225"
assert: count of blocksDownstream($DIAGRAM,"COMMAND-225") = 6  "6 blocks downstream of command 225"
assert: count of blocksDownstream($DIAGRAM,"SOURCECONNECTION-358") = 2 "2 blocks downstream of SOURCECONNECTION-358"

Step: Globally Downstream of Block
assert: blocksGloballyDownstream($DIAGRAM,"DATAPUMP-4") contains "QUALVALUE-805" "QualValue 805 is downstream of datapump 4"
assert: blocksGloballyDownstream($DIAGRAM,"DATAPUMP-4") contains "RoutingParameter" "RoutingParameter is downstream of datapump 4"
assert: count of blocksGloballyDownstream($DIAGRAM,"DATAPUMP-4") = 4  "4 blocks downstream of datapump 4"
assert: blocksGloballyDownstream($DIAGRAM,"COMMAND-225") contains "INHIBITOR-380" "Inhibitor 380 is downstream of command 225"
assert: ! blocksGloballyDownstream($DIAGRAM,"COMMAND-225") contains "RoutingParameter" "RoutingParameter is not downstream of command 225"
assert: count of blocksGloballyDownstream($DIAGRAM,"COMMAND-225") = 15  "15 blocks downstream of command 225 (multiplediagrams)"
assert: count of blocksGloballyDownstream($DIAGRAM,"SINKCONNECTION-538") = 9 "9 blocks downstream of SINKCONNECTION-538"
assert: count of blocksGloballyDownstream($DIAGRAM,"SOURCECONNECTION-358") = 2 "2 blocks downstream of SOURCECONNECTION-358"
assert: blocksGloballyDownstream($DIAGRAM,"SINKCONNECTION-538") contains "PARAMETER-682" "Parameter-682 is downstream of SINKCONNECTION-538"
assert: blocksGloballyDownstream($DIAGRAM,"SINKCONNECTION-538") contains "QUALVALUE-905" "QualValue-905 is downstream of SINKCONNECTION-538"

Step: Upstream of Block 
assert: blocksUpstream($DIAGRAM,"OUTPUT-817") contains "COMMAND-225" "Command-225 is upstream of OUTPUT-817"
assert: blocksUpstream($DIAGRAM,"OUTPUT-817") contains "JUNCTION-605" "Junction-605 is upstream of OUTPUT-817"
assert: !blocksUpstream($DIAGRAM,"OUTPUT-817") contains "OUTPUT-514" "Output 514 is not upstream of OUTPUT-817"
assert: count of blocksUpstream($DIAGRAM,"OUTPUT-817") = 12 "12 blocks upstream of OUTPUT-817"
assert: count of blocksUpstream($DIAGRAM,"DATAPUMP-4") = 0 "0 blocks upstream of data pump"
assert: ! blocksUpstream($DIAGRAM,"QUALVALUE-905") contains "JUNCTION-605" "Junction-605 is not upstream of QUALVALUE-905"

Step: Globally Upstream of Block
assert: blocksGloballyUpstream($DIAGRAM,"OUTPUT-817") contains "COMMAND-225" "Command-225 is upstream of OUTPUT-817"
assert: blocksGloballyUpstream($DIAGRAM,"OUTPUT-817") contains "JUNCTION-605" "Junction-605 is upstream of OUTPUT-817"
assert: !blocksGloballyUpstream($DIAGRAM,"OUTPUT-817") contains "OUTPUT-514" "Output 514 is not upstream of OUTPUT-817"
assert: count of blocksGloballyUpstream($DIAGRAM,"OUTPUT-817") = 12 "12 blocks upstream of OUTPUT-817"
assert: count of blocksGloballyUpstream($DIAGRAM,"DATAPUMP-4") = 0 "0 blocks upstream of data pump"
assert: count of blocksGloballyUpstream($DIAGRAM,"QUALVALUE-905") = 12 "12 blocks upstream of QUALVALUE-905"
assert: count of blocksGloballyUpstream($DIAGRAM,"SOURCECONNECTION-358") = 9 "9 blocks upstream of SOURCECONNECTION-358"
assert: blocksGloballyUpstream($DIAGRAM,"QUALVALUE-905") contains "JUNCTION-605" "Junction-605 is globally upstream of QUALVALUE-905"

Step: Sources for Sink
assert: sourcesForSink($DIAGRAM,"SINKCONNECTION-538") contains "SOURCECONNECTION-761" "Source 761 (Readwrite) is connected"
assert: ! sourcesForSink($DIAGRAM,"SINKCONNECTION-538") contains "RoutingParameter" "RountingParameter is not connected"
assert: count of sourcesForSink($DIAGRAM,"SINKCONNECTION-538") = 1 "1 sources for sink 538"
assert: count of sourcesForSink($DIAGRAM,"DATAPUMP-549") = 0 "0 sources for a data pump"

Step: Sinks for Source
assert: sinksForSource($DIAGRAM,"SOURCECONNECTION-358") contains "SINKCONNECTION-456" "Sink 456 (readwrite) is connected"
assert: ! sinksForSource($DIAGRAM,"SOURCECONNECTION-358") contains "RoutingParameter" "RoutingParameter is not connected"
assert: count of sinksForSource($DIAGRAM,"SOURCECONNECTION-358") = 1 "1 sinks for source 358"
assert: count of sinksForSource($DIAGRAM,"DATAPUMP-676") = 0 "0 sinks for a data pump"

Step: Blocks for Tag
assert: blocksForTag("[XOM_ISOLATION]MemoryTags/StringOut") contains "OUTPUT-514" "Output 514 uses ComparisonOut3"
assert: blocksForTag("[XOM_ISOLATION]MemoryTags/MJKFeed1") contains "INPUT-219" "Input 219 (SQC) uses MJKFeed1"
assert: ! blocksForTag("[XOM_ISOLATION]MemoryTags/MJKFeed1") contains "INHIBITOR-551" "Inhibitor 551 does not use MJKFeed1"
assert: count of blocksForTag("[XOM_ISOLATION]MemoryTags/BooleanFeed") = 4 "4 blocks use BooleanFeed"

Step: Path for Block
assert: pathForBlock($DIAGRAM,"OUTPUT-514") = ":app75:family75:routing:OUTPUT-514" "Path for output 514"
